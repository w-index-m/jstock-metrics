import streamlit as st
import google.generativeai as genai
import yfinance as yf
import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import japanize_matplotlib
from datetime import datetime, timedelta

st.set_page_config(layout="wide")
st.title("📈 日本株 シャープレシオ分析")

GEMINI_API_KEY = st.secrets["GEMINI_API_KEY"]
genai.configure(api_key=GEMINI_API_KEY)
model = genai.GenerativeModel("gemini-2.5-pro")

years = st.number_input("📅 過去何年で分析？", 1, 10, 5)

ticker_name_map = {
    '1332.JP': ('ニッスイ', '水産'),
    '1605.JP': ('ＩＮＰＥＸ', '鉱業'),
    '1721.JP': ('コムシスＨＤ', '建設'),
    '1801.JP': ('大成建', '建設'),
    '1802.JP': ('大林組', '建設'),
    '1803.JP': ('清水建', '建設'),
    '1808.JP': ('長谷工', '建設'),
    '1812.JP': ('鹿島', '建設'),
    '1925.JP': ('ハウス', '建設'),
    '1928.JP': ('積ハウス', '建設'),
    '1963.JP': ('日揮ＨＤ', '建設'),
    '2002.JP': ('日清粉Ｇ', '食品'),
    '2269.JP': ('明治ＨＤ', '食品'),
    '2282.JP': ('日ハム', '食品'),
    '2413.JP': ('エムスリー', 'サービス'),
    '2432.JP': ('ディーエヌエ', 'サービス'),
    '2501.JP': ('サッポロＨＤ', '食品'),
    '2502.JP': ('アサヒ', '食品'),
    '2503.JP': ('キリンＨＤ', '食品'),
    '2768.JP': ('双日', '商社'),
    '2801.JP': ('キッコマン', '食品'),
    '2802.JP': ('味の素', '食品'),
    '2871.JP': ('ニチレイ', '食品'),
    '2914.JP': ('ＪＴ', '食品'),
    '3086.JP': ('Ｊフロント', '小売業'),
    '3092.JP': ('ＺＯＺＯ', '小売業'),
    '3099.JP': ('三越伊勢丹', '小売業'),
    '3289.JP': ('東急不ＨＤ', '不動産'),
    '3382.JP': ('セブン＆アイ', '小売業'),
    '3401.JP': ('帝人', '繊維'),
    '3402.JP': ('東レ', '繊維'),
    '3405.JP': ('クラレ', '化学'),
    '3407.JP': ('旭化成', '化学'),
    '3436.JP': ('ＳＵＭＣＯ', '非鉄・金属'),
    '3659.JP': ('ネクソン', 'サービス'),
    '3861.JP': ('王子ＨＤ', 'パルプ・紙'),
    '4004.JP': ('レゾナック', '化学'),
    '4005.JP': ('住友化', '化学'),
    '4021.JP': ('日産化', '化学'),
    '4042.JP': ('東ソー', '化学'),
    '4043.JP': ('トクヤマ', '化学'),
    '4061.JP': ('デンカ', '化学'),
    '4063.JP': ('信越化', '化学'),
    '4151.JP': ('協和キリン', '医薬品'),
    '4183.JP': ('三井化学', '化学'),
    '4188.JP': ('三菱ケミＧ', '化学'),
    '4208.JP': ('ＵＢＥ', '化学'),
    '4307.JP': ('野村総研', 'サービス'),
    '4324.JP': ('電通グループ', 'サービス'),
    '4385.JP': ('メルカリ', 'サービス'),
    '4452.JP': ('花王', '化学'),
    '4502.JP': ('武田', '医薬品'),
    '4503.JP': ('アステラス', '医薬品'),
    '4506.JP': ('住友ファーマ', '医薬品'),
    '4507.JP': ('塩野義', '医薬品'),
    '4519.JP': ('中外薬', '医薬品'),
    '4523.JP': ('エーザイ', '医薬品'),
    '4543.JP': ('テルモ', '精密機器'),
    '4568.JP': ('第一三共', '医薬品'),
    '4578.JP': ('大塚ＨＤ', '医薬品'),
    '4661.JP': ('ＯＬＣ', 'サービス'),
    '4689.JP': ('ラインヤフー', 'サービス'),
    '4704.JP': ('トレンド', 'サービス'),
    '4751.JP': ('サイバー', 'サービス'),
    '4755.JP': ('楽天グループ', 'サービス'),
    '4901.JP': ('富士フイルム', '化学'),
    '4902.JP': ('コニカミノル', '精密機器'),
    '4911.JP': ('資生堂', '化学'),
    '5019.JP': ('出光興産', '石油'),
    '5020.JP': ('ＥＮＥＯＳ', '石油'),
    '5101.JP': ('浜ゴム', 'ゴム'),
    '5108.JP': ('ブリヂストン', 'ゴム'),
    '5201.JP': ('ＡＧＣ', '窯業'),
    '5214.JP': ('日電硝', '窯業'),
    '5233.JP': ('太平洋セメ', '窯業'),
    '5301.JP': ('東海カーボン', '窯業'),
    '5332.JP': ('ＴＯＴＯ', '窯業'),
    '5333.JP': ('ガイシ', '窯業'),
    '5401.JP': ('日本製鉄', '鉄鋼'),
    '5406.JP': ('神戸鋼', '鉄鋼'),
    '5411.JP': ('ＪＦＥ', '鉄鋼'),
    '5631.JP': ('日製鋼', '機械'),
    '5706.JP': ('三井金', '非鉄・金属'),
    '5711.JP': ('三菱マ', '非鉄・金属'),
    '5713.JP': ('住友鉱', '非鉄・金属'),
    '5714.JP': ('ＤＯＷＡ', '非鉄・金属'),
    '5801.JP': ('古河電', '非鉄・金属'),
    '5802.JP': ('住友電', '非鉄・金属'),
    '5803.JP': ('フジクラ', '非鉄・金属'),
    '5831.JP': ('しずおかＦＧ', '銀行'),
    '6098.JP': ('リクルート', 'サービス'),
    '6103.JP': ('オークマ', '機械'),
    '6113.JP': ('アマダ', '機械'),
    '6146.JP': ('ディスコ', '精密機器'),
    '6178.JP': ('日本郵政', 'サービス'),
    '6273.JP': ('ＳＭＣ', '機械'),
    '6301.JP': ('コマツ', '機械'),
    '6302.JP': ('住友重', '機械'),
    '6305.JP': ('日立建機', '機械'),
    '6326.JP': ('クボタ', '機械'),
    '6361.JP': ('荏原', '機械'),
    '6367.JP': ('ダイキン', '機械'),
    '6471.JP': ('日精工', '機械'),
    '6472.JP': ('ＮＴＮ', '機械'),
    '6473.JP': ('ジェイテクト', '機械'),
    '6479.JP': ('ミネベア', '電気機器'),
    '6501.JP': ('日立', '電気機器'),
    '6503.JP': ('三菱電', '電気機器'),
    '6504.JP': ('富士電機', '電気機器'),
    '6506.JP': ('安川電', '電気機器'),
    '6526.JP': ('ソシオネクス', '電気機器'),
    '6532.JP': ('ベイカレント', 'サービス'),
    '6594.JP': ('ニデック', '電気機器'),
    '6645.JP': ('オムロン', '電気機器'),
    '6674.JP': ('ＧＳユアサ', '電気機器'),
    '6701.JP': ('ＮＥＣ', '電気機器'),
    '6702.JP': ('富士通', '電気機器'),
    '6723.JP': ('ルネサス', '電気機器'),
    '6724.JP': ('エプソン', '電気機器'),
    '6752.JP': ('パナＨＤ', '電気機器'),
    '6753.JP': ('シャープ', '電気機器'),
    '6758.JP': ('ソニーＧ', '電気機器'),
    '6762.JP': ('ＴＤＫ', '電気機器'),
    '6770.JP': ('アルプスアル', '電気機器'),
    '6841.JP': ('横河電', '電気機器'),
    '6857.JP': ('アドテスト', '電気機器'),
    '6861.JP': ('キーエンス', '電気機器'),
    '6902.JP': ('デンソー', '電気機器'),
    '6920.JP': ('レーザーテク', '電気機器'),
    '6952.JP': ('カシオ', '電気機器'),
    '6954.JP': ('ファナック', '電気機器'),
    '6971.JP': ('京セラ', '電気機器'),
    '6976.JP': ('太陽誘電', '電気機器'),
    '6981.JP': ('村田製', '電気機器'),
    '6988.JP': ('日東電', '化学'),
    '7004.JP': ('カナデビア', '機械'),
    '7011.JP': ('三菱重', '機械'),
    '7012.JP': ('川重', '造船'),
    '7013.JP': ('ＩＨＩ', '機械'),
    '7186.JP': ('コンコルディ', '銀行'),
    '7201.JP': ('日産自', '自動車'),
    '7202.JP': ('いすゞ', '自動車'),
    '7203.JP': ('トヨタ', '自動車'),
    '7205.JP': ('日野自', '自動車'),
    '7211.JP': ('三菱自', '自動車'),
    '7261.JP': ('マツダ', '自動車'),
    '7267.JP': ('ホンダ', '自動車'),
    '7269.JP': ('スズキ', '自動車'),
    '7270.JP': ('ＳＵＢＡＲＵ', '自動車'),
    '7272.JP': ('ヤマハ発', '自動車'),
    '7453.JP': ('良品計画', '小売業'),
    '7731.JP': ('ニコン', '精密機器'),
    '7733.JP': ('オリンパス', '精密機器'),
    '7735.JP': ('スクリン', '電気機器'),
    '7741.JP': ('ＨＯＹＡ', '精密機器'),
    '7751.JP': ('キヤノン', '電気機器'),
    '7752.JP': ('リコー', '電気機器'),
    '7762.JP': ('シチズン', '精密機器'),
    '7832.JP': ('バンナムＨＤ', 'その他製造'),
    '7911.JP': ('ＴＯＰＰＡＮ', 'その他製造'),
    '7912.JP': ('大日印', 'その他製造'),
    '7951.JP': ('ヤマハ', 'その他製造'),
    '7974.JP': ('任天堂', 'サービス'),
    '8001.JP': ('伊藤忠', '商社'),
    '8002.JP': ('丸紅', '商社'),
    '8015.JP': ('豊田通商', '商社'),
    '8031.JP': ('三井物', '商社'),
    '8035.JP': ('東エレク', '電気機器'),
    '8053.JP': ('住友商', '商社'),
    '8058.JP': ('三菱商', '商社'),
    '8233.JP': ('高島屋', '小売業'),
    '8252.JP': ('丸井Ｇ', '小売業'),
    '8253.JP': ('クレセゾン', 'その他金融'),
    '8267.JP': ('イオン', '小売業'),
    '8304.JP': ('あおぞら銀', '銀行'),
    '8306.JP': ('三菱ＵＦＪ', '銀行'),
    '8308.JP': ('りそなＨＤ', '銀行'),
    '8309.JP': ('三井住友トラ', '銀行'),
    '8316.JP': ('三井住友ＦＧ', '銀行'),
    '8331.JP': ('千葉銀', '銀行'),
    '8354.JP': ('ふくおかＦＧ', '銀行'),
    '8411.JP': ('みずほＦＧ', '銀行'),
    '8591.JP': ('オリックス', 'その他金融'),
    '8601.JP': ('大和', '証券'),
    '8604.JP': ('野村', '証券'),
    '8630.JP': ('ＳＯＭＰＯ', '保険'),
    '8697.JP': ('日本取引所', 'その他金融'),
    '8725.JP': ('ＭＳ＆ＡＤ', '保険'),
    '8750.JP': ('第一生命ＨＤ', '保険'),
    '8766.JP': ('東京海上', '保険'),
    '8795.JP': ('Ｔ＆Ｄ', '保険'),
    '8801.JP': ('三井不', '不動産'),
    '8802.JP': ('菱地所', '不動産'),
    '8804.JP': ('東建物', '不動産'),
    '8830.JP': ('住友不', '不動産'),
    '9001.JP': ('東武', '鉄道・バス'),
    '9005.JP': ('東急', '鉄道・バス'),
    '9007.JP': ('小田急', '鉄道・バス'),
    '9008.JP': ('京王', '鉄道・バス'),
    '9009.JP': ('京成', '鉄道・バス'),
    '9020.JP': ('ＪＲ東日本', '鉄道・バス'),
    '9021.JP': ('ＪＲ西日本', '鉄道・バス'),
    '9022.JP': ('ＪＲ東海', '鉄道・バス'),
    '9064.JP': ('ヤマトＨＤ', '陸運'),
    '9101.JP': ('郵船', '海運'),
    '9104.JP': ('商船三井', '海運'),
    '9107.JP': ('川崎汽', '海運'),
    '9147.JP': ('ＮＸＨＤ', '陸運'),
    '9201.JP': ('ＪＡＬ', '空運'),
    '9202.JP': ('ＡＮＡＨＤ', '空運'),
    '9432.JP': ('ＮＴＴ', '通信'),
    '9433.JP': ('ＫＤＤＩ', '通信'),
    '9434.JP': ('ＳＢ', '通信'),
    '9501.JP': ('東電ＨＤ', '電力'),
    '9502.JP': ('中部電', '電力'),
    '9503.JP': ('関西電', '電力'),
    '9531.JP': ('東ガス', 'ガス'),
    '9532.JP': ('大ガス', 'ガス'),
    '9602.JP': ('東宝', 'サービス'),
    '9613.JP': ('ＮＴＴデータ', '通信'),
    '9735.JP': ('セコム', 'サービス'),
    '9766.JP': ('コナミＧ', 'サービス'),
    '9843.JP': ('ニトリＨＤ', '小売業'),
    '9983.JP': ('ファストリ', '小売業'),
    '9984.JP': ('ＳＢＧ', '通信'),
}

@st.cache_data(ttl=3600)
def get_price(ticker, start, end):
    df = yf.download(ticker, start=start, end=end, progress=False)
    return df

if st.button("分析実行"):

    end_date = datetime.today()
    start_date = end_date - timedelta(days=years*365)

    benchmark = yf.download("^N225", start=start_date, end=end_date, progress=False)

    if benchmark.empty:
        st.error("市場データ取得失敗")
        st.stop()

    market_returns = benchmark["Close"].pct_change().dropna()
    annual_market_return = market_returns.mean() * 252

    results = []
    progress = st.progress(0)

    for i, (ticker, (name, sector)) in enumerate(ticker_name_map.items()):
        df = get_price(ticker, start_date, end_date)
        progress.progress((i+1)/len(ticker_name_map))

        if df.empty:
            continue

        returns = df["Close"].pct_change().dropna()
        common = returns.index.intersection(market_returns.index)

        if len(common) < 30:
            continue

        x = returns.loc[common].values
        y = market_returns.loc[common].values

        annual_return = x.mean()*252
        annual_vol = x.std()*np.sqrt(252)
        beta = np.cov(x,y)[0][1]/np.var(y)
        sharpe = (annual_return-0.01)/annual_vol

        results.append({
            "企業名": name,
            "年間リターン": annual_return,
            "年間リスク": annual_vol,
            "シャープレシオ": sharpe
        })

    df_results = pd.DataFrame(results)

    if df_results.empty:
        st.error("データなし")
        st.stop()

    df_results = df_results.sort_values("シャープレシオ", ascending=False)

    fig, ax = plt.subplots(figsize=(10,6))
    ax.bar(df_results["企業名"], df_results["シャープレシオ"])
    ax.set_title("シャープレシオ")
    ax.tick_params(axis='x', rotation=45)
    st.pyplot(fig)

    # Geminiコメント
    summary = df_results.head(3).to_string()

    prompt = f"""
    以下の日本株分析結果を投資家向けに300文字で要約してください。

    {summary}
    """

    try:
        response = model.generate_content(prompt)
        st.subheader("🤖 AIコメント")
        st.write(response.text)
    except:
        st.warning("Geminiエラー")
